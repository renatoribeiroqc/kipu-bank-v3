<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KipuBankV3 • Remix Demo (Router Swaps)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  <style>
    body { background: #f7f9fc; }
    .app { max-width: 560px; margin: 0 auto; padding: 16px; }
    .card { border-radius: 14px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .disabled-card { opacity:.55; pointer-events:none; filter: grayscale(.1); }
    .fullw { width: 100%; }
    .tiny { font-size: 12px; }
  </style>
  <!-- Note: This is a simple demo; for production, use official Uniswap helpers for command encoding. -->
</head>
<body>
  <div class="app">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h1 class="h5 mb-0">KipuBankV3 – USDC Vault (v4 Router)</h1>
        <div id="network" class="small text-secondary">Not connected</div>
      </div>
      <button id="btnConnect" class="btn btn-primary btn-sm">Connect Wallet</button>
    </div>

    <!-- Step 1: attach contract -->
    <div id="cardAttach" class="card mb-3 disabled-card">
      <div class="card-body">
        <div class="h6 mb-2">Step 1 — Contract</div>
        <label class="form-label small">Contract Address</label>
        <input id="contractAddress" class="form-control mono" type="text" placeholder="0xKipuBankV3" />
        <button id="btnAttach" class="btn btn-outline-secondary fullw mt-2">Attach (confirm contract)</button>
        <div class="row g-2 mt-3">
          <div class="col-4">
            <div class="small text-secondary">Cap (USD-6)</div>
            <div id="cap" class="mono">—</div>
          </div>
          <div class="col-4">
            <div class="small text-secondary">Total (USD-6)</div>
            <div id="total" class="mono">—</div>
          </div>
          <div class="col-4">
            <div class="small text-secondary">Version</div>
            <div id="version" class="mono">—</div>
          </div>
        </div>
        <div id="s1" class="tiny text-secondary mt-2">Connect wallet first. Then click Attach to confirm the contract.</div>
      </div>
    </div>

    <!-- Step 2: deposit -->
    <div id="cardDeposit" class="card mb-3 disabled-card">
      <div class="card-body">
        <div class="h6 mb-2">Step 2 — Deposit (Swap to USDC)</div>
        <div class="small text-secondary mb-2">USDC and Router Settings</div>

        <div class="row g-2">
          <div class="col-6">
            <label class="form-label small">USDC (Sepolia)</label>
            <input id="usdcAddr" class="form-control mono" type="text" value="0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238" />
          </div>
          <div class="col-6">
            <label class="form-label small">Fee (bps)</label>
            <input id="feeTier" class="form-control mono" type="number" value="3000" />
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-12 small text-secondary">Select Asset and Amount</div>
          <div class="col-6">
            <label class="form-label small">Asset Preset</label>
            <select id="preset" class="form-select mono">
              <option value="ETH" selected>ETH (native)</option>
              <option value="USDC">USDC (ERC-20)</option>
              <option value="CUSTOM">Custom ERC-20</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label small">Token In (ERC-20 or 0x0 for ETH)</label>
            <input id="tokenIn" class="form-control mono" type="text" value="0x0000000000000000000000000000000000000000" />
          </div>
          <div class="col-6">
            <label class="form-label small">Amount In</label>
            <input id="amountIn" class="form-control mono" type="text" value="0.01" />
          </div>
          <div class="col-12" id="tokenInfo"></div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-6">
            <label class="form-label small">Min USDC Out (USD-6)</label>
            <input id="minUsdcOut" class="form-control mono" type="number" value="0" />
          </div>
          <div class="col-6">
            <label class="form-label small">Deadline (+seconds)</label>
            <input id="deadlineSecs" class="form-control mono" type="number" value="300" />
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button id="btnDepositETH" class="btn btn-success flex-fill" disabled>Deposit ETH → USDC</button>
          <button id="btnDepositERC20" class="btn btn-primary flex-fill" disabled>Deposit Token → USDC</button>
        </div>
        <div class="d-flex gap-2 mt-2">
          <button id="btnApproveToken" class="btn btn-outline-secondary flex-fill" disabled>Approve Token (ERC-20)</button>
        </div>
        <div id="s2" class="tiny text-secondary mt-2">For ETH: click “Deposit ETH → USDC”. For USDC or Custom ERC‑20: click “Approve Token (ERC‑20)”, then “Deposit Token → USDC”.</div>
      </div>
    </div>

    <!-- Step 3: withdraw USDC -->
    <div id="cardUse" class="card mb-3 disabled-card">
      <div class="card-body">
        <div class="h6 mb-2">Step 3 — Withdraw USDC</div>
        <div class="mb-2">
          <label class="form-label small">My Address</label>
          <input id="me" class="form-control mono" type="text" readonly />
        </div>
        <div class="mb-2">
          <label class="form-label small">My Balance (USDC, USD-6)</label>
          <input id="myBal" class="form-control mono" type="text" readonly />
        </div>

        <div class="d-flex gap-2 mb-2">
          <button id="btnRefresh" class="btn btn-outline-secondary flex-fill">Refresh</button>
        </div>

        <div class="row g-2 align-items-end">
          <div class="col-7">
            <label class="form-label small">Withdraw Amount (USD-6)</label>
            <input id="amtOut" type="number" inputmode="decimal" min="0" step="1" placeholder="1000000 for $1" class="form-control" />
          </div>
          <div class="col-5">
            <button id="btnWithdraw" class="btn btn-warning fullw">Withdraw</button>
          </div>
        </div>

        <div id="counters" class="small text-secondary mt-2">Deposits: — · Withdrawals: —</div>
        <div id="s3" class="tiny text-secondary mt-2">Attach, deposit (swap to USDC), then withdraw USDC.</div>
      </div>
    </div>

    <!-- Logs -->
    <div id="cardLogs" class="card disabled-card">
      <div class="card-body">
        <div class="h6 mb-2">Logs</div>
        <div id="logs" class="small mono">—</div>
      </div>
    </div>

    <p class="small text-center text-secondary mt-3 mb-0">
      Use Sepolia. Router payloads are single-hop examples; adjust fee/pairs as needed.
    </p>
  </div>

<script>
(function () {
  const $ = (id) => document.getElementById(id);
  const fmtEth = (wei) => ethers.formatEther(wei);
  const toWei = (eth) => ethers.parseEther(String(eth));
  const fmtUsd6 = (n) => `${Number(n)/1e6}`;

  // ABI for KipuBankV3
  const abi = [
    "function VERSION() view returns (string)",
    "function bankCapUsdc6() view returns (uint256)",
    "function totalUsdc() view returns (uint256)",
    "function depositCount() view returns (uint256)",
    "function withdrawalCount() view returns (uint256)",
    "function capRemaining() view returns (uint256)",
    "function balanceUsdc(address) view returns (uint256)",
    "function depositUSDC(uint256 amount)",
    "function depositETH(bytes commands, bytes[] inputs, uint256 minUsdcOut, uint256 deadline) payable",
    "function depositArbitraryToken(address token, uint256 amountIn, bytes commands, bytes[] inputs, uint256 minUsdcOut, uint256 deadline)",
    "function withdrawUSDC(uint256 amountUsdc, address to)"
  ];

  let provider, signer, me, contract;

  // Minimal ERC-20 ABI for approve
  const erc20Abi = [
    "function approve(address spender, uint256 amount) returns (bool)",
    "function decimals() view returns (uint8)",
    "function balanceOf(address) view returns (uint256)",
    "function allowance(address owner, address spender) view returns (uint256)"
  ];

  function setEnabled(id, on) { $(id).classList.toggle('disabled-card', !on); }
  function log(line, ok = true) {
    const el = $("logs");
    el.textContent = (el.textContent === "—" ? "" : el.textContent + "\n") + (ok ? "✅ " : "⛔ ") + line;
  }

  async function refreshHeader() {
    if (!contract) return;
    const [cap, tot, ver] = await Promise.all([
      contract.bankCapUsdc6(), contract.totalUsdc(), contract.VERSION()
    ]);
    $("cap").textContent = cap.toString();
    $("total").textContent = tot.toString();
    $("version").textContent = ver;
    const [dep, wdr] = await Promise.all([contract.depositCount(), contract.withdrawalCount()]);
    $("counters").textContent = `Deposits: ${dep} · Withdrawals: ${wdr}`;
  }

  async function refreshBalance() {
    if (!contract || !me) return;
    const bal = await contract.balanceUsdc(me);
    $("myBal").value = bal.toString();
  }

  // Wallet connect
  $("btnConnect").onclick = async () => {
    if (!window.ethereum) { $("network").textContent = "MetaMask not found"; return; }
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = await provider.getSigner();
    me = await signer.getAddress();
    const net = await provider.getNetwork();
    $("network").textContent = `Connected: ${net.name ?? "unknown"} (chainId ${net.chainId})`;
    $("me").value = me;
    // Enable Step 1 and preload default contract
    setEnabled("cardAttach", true);
    const def = "0xe209966a90da0bbd2e6fe06f5bc40df2b01ade51";
    $("contractAddress").value = def;
    $("s1").textContent = "Default contract loaded. Click Attach to confirm.";
  };

  // Attach contract
  $("btnAttach").onclick = async () => {
    try {
      const addr = $("contractAddress").value.trim();
      if (!ethers.isAddress(addr)) { $("s1").textContent = "Invalid contract address"; return; }
      contract = new ethers.Contract(addr, abi, signer || (provider && (await provider.getSigner())));
      await refreshHeader();
      setEnabled("cardDeposit", true);
      setEnabled("cardUse", true);
      setEnabled("cardLogs", true);
      $("s1").textContent = "Attached. Step 2 enabled.";
      updatePresetState();
    } catch (e) {
      console.error(e); $("s1").textContent = e?.reason || e?.message || "Attach failed";
    }
  };

  // Build Universal Router payload for v4 exact-in single hop
  function buildPayload(tokenIn, usdc, fee, amountIn, minOut) {
    const coder = ethers.AbiCoder.defaultAbiCoder();
    const actions = "0x000203"; // SWAP_EXACT_IN_SINGLE, SETTLE_ALL, TAKE_ALL
    const key = [tokenIn, usdc, fee];
    const p0 = coder.encode([
      'tuple(tuple(address,address,uint24),bool,uint128,uint128,bytes)'
    ], [[ key, true, BigInt(amountIn), BigInt(minOut), '0x' ]]);
    const p1 = coder.encode(['address','uint256'], [tokenIn, BigInt(amountIn)]);
    const p2 = coder.encode(['address','uint256'], [usdc, BigInt(minOut)]);
    const inputs = coder.encode(['bytes','bytes[]'], [actions, [p0, p1, p2]]);
    return { commands: '0x0b', inputs: [inputs] };
  }

  $("btnRefresh").onclick = async () => { await refreshHeader(); await refreshBalance(); };

  // Preset selector: enable relevant buttons and defaults
  function updatePresetState() {
    const p = $("preset").value;
    const usdc = $("usdcAddr").value.trim();
    const btnEth = $("btnDepositETH");
    const btnTok = $("btnDepositERC20");
    const btnAppr = $("btnApproveToken");
    $("tokenIn").classList.remove('is-invalid');
    $("amountIn").classList.remove('is-invalid');
    if (p === 'ETH') {
      $("tokenIn").value = ethers.ZeroAddress;
      $("amountIn").value = '0.01';
      btnEth.disabled = false; btnTok.disabled = true; btnAppr.disabled = true;
      $("s2").textContent = "ETH selected: Click ‘Deposit ETH → USDC’.";
    } else if (p === 'USDC') {
      $("tokenIn").value = usdc;
      $("amountIn").value = '1000000';
      btnEth.disabled = true; btnTok.disabled = false; btnAppr.disabled = false;
      $("s2").textContent = "USDC selected: Prefer ‘Deposit USDC’ in Remix or use this page: Approve then Deposit Token → USDC (direct path used).";
    } else {
      btnEth.disabled = true; btnTok.disabled = false; btnAppr.disabled = false;
      if (!ethers.isAddress($("tokenIn").value.trim())) $("tokenIn").classList.add('is-invalid');
      if (!$("amountIn").value.trim()) $("amountIn").classList.add('is-invalid');
      $("s2").textContent = "Custom token: Paste token address, Approve, then Deposit Token → USDC.";
    }
  }
  $("preset").onchange = updatePresetState;

  // Approve ERC-20 to KipuBankV3 for amountIn
  $("btnApproveToken").onclick = async () => {
    try {
      if (!contract) { $("s2").textContent = "Attach contract first."; return; }
      const tokenIn = $("tokenIn").value.trim();
      const amountIn = $("amountIn").value.trim();
      if (!ethers.isAddress(tokenIn) || tokenIn === ethers.ZeroAddress) { $("s2").textContent = "Enter ERC-20 address"; return; }
      const token = new ethers.Contract(tokenIn, erc20Abi, signer);
      const spender = await contract.getAddress();
      const tx = await token.approve(spender, BigInt(amountIn));
      await tx.wait(); log(`Approved ${amountIn} units for ${tokenIn}`);
    } catch (e) { console.error(e); log(`Approve failed: ${e?.reason || e?.message}`, false); }
  };

  // Deposit ETH → USDC
  $("btnDepositETH").onclick = async () => {
    try {
      if (!contract) { $("s2").textContent = "Attach contract first."; return; }
      const usdc = $("usdcAddr").value.trim();
      const fee = Number($("feeTier").value);
      const amountEth = $("amountIn").value.trim();
      const minUsdcOut = BigInt($("minUsdcOut").value || '0');
      const deadline = BigInt(Math.floor(Date.now()/1000) + Number($("deadlineSecs").value || '300'));
      if (!ethers.isAddress(usdc)) { $("s2").textContent = "Invalid USDC"; return; }
      const { commands, inputs } = buildPayload(ethers.ZeroAddress, usdc, fee, toWei(amountEth), minUsdcOut);
      const tx = await contract.depositETH(commands, inputs, minUsdcOut, deadline, { value: toWei(amountEth) });
      await tx.wait(); log(`Deposited ETH→USDC, minOut ${minUsdcOut.toString()}`);
      await refreshHeader(); await refreshBalance();
    } catch (e) { console.error(e); log(`Deposit ETH failed: ${e?.reason || e?.message}`, false); }
  };

  // Deposit ERC20 → USDC
  $("btnDepositERC20").onclick = async () => {
    try {
      if (!contract) { $("s2").textContent = "Attach contract first."; return; }
      const tokenIn = $("tokenIn").value.trim();
      const usdc = $("usdcAddr").value.trim();
      const fee = Number($("feeTier").value);
      const amountIn = $("amountIn").value.trim();
      const minUsdcOut = BigInt($("minUsdcOut").value || '0');
      const deadline = BigInt(Math.floor(Date.now()/1000) + Number($("deadlineSecs").value || '300'));
      if (!ethers.isAddress(tokenIn)) { $("s2").textContent = "Invalid token address"; return; }
      if (!ethers.isAddress(usdc)) { $("s2").textContent = "Invalid USDC"; return; }
      const { commands, inputs } = buildPayload(tokenIn, usdc, fee, BigInt(amountIn), minUsdcOut);
      // User must have approved the bank to pull amountIn beforehand
      const tx = await contract.depositArbitraryToken(tokenIn, BigInt(amountIn), commands, inputs, minUsdcOut, deadline);
      await tx.wait(); log(`Deposited token→USDC, minOut ${minUsdcOut.toString()}`);
      await refreshHeader(); await refreshBalance();
    } catch (e) { console.error(e); log(`Deposit token failed: ${e?.reason || e?.message}`, false); }
  };

  // Withdraw
  $("btnWithdraw").onclick = async () => {
    try {
      if (!contract) { $("s3").textContent = "Attach contract first."; return; }
      const val = $("amtOut").value;
      if (!val || Number(val) <= 0) { $("s3").textContent = "Enter a withdrawal > 0."; return; }
      const to = me;
      const amount = BigInt(val);
      const tx = await contract.withdrawUSDC(amount, to);
      await tx.wait(); log(`Withdrew ${amount.toString()} USDC-6`);
      await refreshHeader(); await refreshBalance();
    } catch (e) {
      console.error(e); log(`Withdraw failed: ${e?.reason || e?.message}`, false);
      $("s3").textContent = e?.reason || e?.message || "Withdraw failed";
    }
  };
  
  // Token info: decimals, balance, allowance
  async function loadTokenInfo() {
    try {
      const elInfo = document.getElementById('tokenInfo');
      const t = $("tokenIn").value.trim();
      if (!ethers.isAddress(t) || t === ethers.ZeroAddress || !contract || !me) { if (elInfo) elInfo.textContent = ''; return; }
      const token = new ethers.Contract(t, erc20Abi, signer || provider);
      const bankAddr = await contract.getAddress();
      const [dec, bal, allw] = await Promise.all([
        token.decimals(), token.balanceOf(me), token.allowance(me, bankAddr)
      ]);
      if (elInfo) {
        elInfo.innerHTML = `<div class="tiny text-secondary">Token Decimals: ${dec} · My Balance: ${bal.toString()} · Allowance to Bank: ${allw.toString()}</div>`;
      }
    } catch {}
  }

  // Recompute token info when fields change
  $("tokenIn").addEventListener('blur', () => loadTokenInfo());
  $("usdcAddr").addEventListener('blur', () => updatePresetState());
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
